---
title: Oracles
description: Price feeds and oracle integration for DeFi protocols
---

# Oracles

Decentralized price feeds and oracle infrastructure for Lux DeFi protocols.

## Overview

The oracle system provides:

- **Multi-Source Aggregation**: Chainlink, Pyth, TWAP combined
- **Manipulation Resistance**: Time-weighted and median pricing
- **Cross-Chain Prices**: Unified pricing across all Lux chains
- **Real-Time Updates**: Sub-second price updates via Warp

```
┌─────────────────────────────────────────────────────────────┐
│                    ORACLE AGGREGATOR                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌──────────┐   ┌──────────┐   ┌──────────┐               │
│   │Chainlink │   │   Pyth   │   │   TWAP   │               │
│   │  Feed    │   │  Feed    │   │  (AMM)   │               │
│   └────┬─────┘   └────┬─────┘   └────┬─────┘               │
│        │              │              │                      │
│        └──────────────┼──────────────┘                      │
│                       │                                      │
│              ┌────────▼────────┐                            │
│              │  Median Price   │                            │
│              │  + Deviation    │                            │
│              │    Check        │                            │
│              └────────┬────────┘                            │
│                       │                                      │
│              ┌────────▼────────┐                            │
│              │  Final Price    │                            │
│              └─────────────────┘                            │
└─────────────────────────────────────────────────────────────┘
```

## Oracle Contracts

| Contract | Path | Purpose |
|----------|------|---------|
| **ChainlinkOracle** | `@luxfi/contracts/markets/oracles/ChainlinkOracle.sol` | Chainlink feed integration for Markets |
| **PythOracle** | `@luxfi/contracts/markets/oracles/PythOracle.sol` | Pyth Network integration for Markets |
| **VaultPriceFeed** | `@luxfi/contracts/perps/core/VaultPriceFeed.sol` | Multi-source aggregation for Perps |
| **FastPriceFeed** | `@luxfi/contracts/perps/oracle/FastPriceFeed.sol` | Low-latency price updates for Perps |
| **PriceAggregator** | `@luxfi/contracts/amm/PriceAggregator.sol` | TWAP from AMM pools |

## Interface

```solidity
import "@luxfi/contracts/markets/interfaces/IOracle.sol";

/// @notice Oracle interface for Markets price feeds
interface IOracle {
    /// @notice Returns the price of the collateral asset in terms of the loan asset
    /// @dev Price is scaled by 1e36 (ORACLE_PRICE_SCALE)
    /// @return The price with 36 decimals of precision
    function price() external view returns (uint256);
}
```

## PriceOracle

Aggregates prices from multiple sources with deviation checks.

```solidity
interface IPriceOracle {
    /// @notice Get the latest price for an asset
    /// @param asset The asset address
    /// @return price The price in USD (18 decimals)
    /// @return timestamp When the price was updated
    function getPrice(address asset) external view returns (
        uint256 price,
        uint256 timestamp
    );

    /// @notice Get price with validation
    /// @param asset The asset address
    /// @param maxAge Maximum age in seconds
    /// @return price The validated price
    function getPriceValidated(address asset, uint256 maxAge)
        external view returns (uint256 price);

    /// @notice Check if price is fresh
    function isPriceFresh(address asset, uint256 maxAge)
        external view returns (bool);
}
```

### Usage

```solidity
import "@luxfi/standard/src/oracles/PriceOracle.sol";

contract LendingPool {
    IPriceOracle public oracle;

    function getCollateralValue(
        address asset,
        uint256 amount
    ) public view returns (uint256) {
        (uint256 price,) = oracle.getPrice(asset);
        return (amount * price) / 1e18;
    }

    function isPositionHealthy(
        address user,
        address collateral,
        address debt
    ) public view returns (bool) {
        uint256 collateralValue = getCollateralValue(
            collateral,
            userCollateral[user]
        );
        uint256 debtValue = getCollateralValue(debt, userDebt[user]);

        return collateralValue * 100 >= debtValue * 150; // 150% collateral ratio
    }
}
```

## TWAP Oracle

Time-weighted average price from AMM pools.

```solidity
interface ITWAPOracle {
    /// @notice Get TWAP over a period
    /// @param tokenA First token
    /// @param tokenB Second token
    /// @param period TWAP period in seconds
    /// @return price Time-weighted average price
    function getTWAP(
        address tokenA,
        address tokenB,
        uint256 period
    ) external view returns (uint256 price);

    /// @notice Update price accumulator
    function update(address tokenA, address tokenB) external;

    /// @notice Get current spot price
    function getSpotPrice(address tokenA, address tokenB)
        external view returns (uint256);
}
```

### TWAP Calculation

```solidity
// Get 30-minute TWAP for LUX/USDC
uint256 twap = twapOracle.getTWAP(WLUX, USDC, 30 minutes);

// Compare with spot for manipulation detection
uint256 spot = twapOracle.getSpotPrice(WLUX, USDC);

// Deviation check
uint256 deviation = spot > twap
    ? ((spot - twap) * 100) / twap
    : ((twap - spot) * 100) / twap;

require(deviation < 5, "Price manipulation detected");
```

## Chainlink Integration

```solidity
import "@luxfi/contracts/markets/oracles/ChainlinkOracle.sol";

// Deploy oracle for ETH/USDC market
ChainlinkOracle oracle = new ChainlinkOracle(
    0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419, // ETH/USD Chainlink feed
    address(0),                                   // USDC is USD-denominated
    18,                                           // ETH decimals
    6,                                            // USDC decimals
    3600                                          // 1 hour max staleness
);

// Get price (scaled to 1e36)
uint256 ethPriceInUsdc = oracle.price();
```

### ChainlinkOracle Constructor

```solidity
constructor(
    address _baseFeed,        // Chainlink feed for collateral (e.g., ETH/USD)
    address _quoteFeed,       // Chainlink feed for loan asset (address(0) if USD)
    uint8 _baseTokenDecimals, // Decimals of collateral token
    uint8 _quoteTokenDecimals,// Decimals of loan token
    uint256 _maxStaleness     // Maximum age of price data in seconds
)
```

## Pyth Integration

```solidity
import "@luxfi/contracts/markets/oracles/PythOracle.sol";

// Pyth price feed IDs (from pyth.network)
bytes32 constant ETH_USD = 0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace;
bytes32 constant BTC_USD = 0xe62df6c8b4a85fe1a67db44dc12de5db330f7ac66b72dc658afedf0f4a415b43;

// Deploy oracle for ETH/USDC market
PythOracle oracle = new PythOracle(
    0x4305FB66699C3B2702D4d05CF36551390A4c69C6, // Pyth contract (mainnet)
    ETH_USD,                                      // ETH/USD price feed ID
    bytes32(0),                                   // USDC is USD-denominated
    18,                                           // ETH decimals
    6,                                            // USDC decimals
    60                                            // 60 second max staleness
);

// Get price (scaled to 1e36)
uint256 ethPriceInUsdc = oracle.price();
```

### PythOracle Constructor

```solidity
constructor(
    address _pyth,             // Pyth oracle contract address
    bytes32 _baseFeedId,       // Pyth feed ID for collateral (e.g., ETH/USD)
    bytes32 _quoteFeedId,      // Pyth feed ID for loan token (bytes32(0) if USD)
    uint8 _baseTokenDecimals,  // Decimals of collateral token
    uint8 _quoteTokenDecimals, // Decimals of loan token
    uint256 _maxStaleness      // Maximum age of price data in seconds
)
```

### Pyth Price Update

Pyth requires explicit price updates. Include update data in your transaction:

```solidity
// Frontend: fetch update data from Pyth API
// const updateData = await connection.getPriceFeedsUpdateData([ETH_USD]);

// Contract: update before reading
pyth.updatePriceFeeds{value: updateFee}(updateData);
uint256 price = oracle.price();
```

## Cross-Chain Oracle

Propagate prices across chains via Warp.

```solidity
contract CrossChainOracle {
    IWarpMessenger constant WARP = IWarpMessenger(0x0200000000000000000000000000000000000008);

    mapping(address => uint256) public prices;
    mapping(address => uint256) public timestamps;

    bytes32 public trustedSourceChain;
    address public trustedPriceRelayer;

    /// @notice Receive price update from another chain
    function receivePriceUpdate(uint32 warpIndex) external {
        WarpMessage memory message = WARP.getVerifiedWarpMessage(warpIndex);

        require(message.sourceChainID == trustedSourceChain, "Untrusted chain");
        require(message.originSenderAddress == trustedPriceRelayer, "Untrusted relayer");

        (address[] memory assets, uint256[] memory newPrices, uint256 timestamp) =
            abi.decode(message.payload, (address[], uint256[], uint256));

        for (uint i = 0; i < assets.length; i++) {
            prices[assets[i]] = newPrices[i];
            timestamps[assets[i]] = timestamp;
        }
    }

    /// @notice Broadcast prices to other chains
    function broadcastPrices(address[] calldata assets) external {
        uint256[] memory currentPrices = new uint256[](assets.length);

        for (uint i = 0; i < assets.length; i++) {
            (currentPrices[i],) = mainOracle.getPrice(assets[i]);
        }

        bytes memory payload = abi.encode(assets, currentPrices, block.timestamp);
        WARP.sendWarpMessage(payload);
    }
}
```

## Supported Assets

| Asset | Sources | Update Frequency |
|-------|---------|------------------|
| LUX | Chainlink, TWAP | 1 min |
| LUXD | Chainlink, Pyth | 1 min |
| WETH | Chainlink, Pyth, TWAP | 10 sec |
| WBTC | Chainlink, Pyth | 10 sec |
| USDC | Chainlink, Pyth | 1 min |
| USDT | Chainlink, Pyth | 1 min |
| AI | TWAP | 1 min |

## Price Feed Addresses

```solidity
// C-Chain Price Feeds
address constant ORACLE = 0x...;
address constant LUX_USD_FEED = 0x...;
address constant ETH_USD_FEED = 0x...;
address constant BTC_USD_FEED = 0x...;
```

## Best Practices

1. **Always validate freshness**: Check `timestamp` against `maxAge`
2. **Use multiple sources**: Aggregate Chainlink + TWAP for resilience
3. **Deviation checks**: Compare sources, reject if deviation > 5%
4. **Fallback handling**: Have backup sources if primary fails
5. **Gas optimization**: Cache prices when possible

## Security Considerations

| Risk | Mitigation |
|------|------------|
| Stale prices | Freshness checks with maxAge |
| Flash loan manipulation | TWAP over 30+ minutes |
| Single source failure | Multi-source aggregation |
| Front-running | Commit-reveal for sensitive ops |

## Related

- [Lending](/docs/defi/lending) - Uses oracles for collateral valuation
- [Perpetuals](/docs/defi/perps) - Uses oracles for mark price
- [Liquidations](/docs/defi/lending#liquidation) - Oracle-triggered liquidations
