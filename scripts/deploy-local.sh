#!/bin/bash
# Deploy AMM contracts to local Lux network

set -e

RPC_URL="http://localhost:9630/ext/bc/C/rpc"
PRIVATE_KEY="95a452d218b45566d386e2053adfd05810202fe818ee7eb14a902f75b2e7d043"
DEPLOYER="0x1833c6f30a7cc985fd329c0c8a8bab25a8262640"

echo "=== Deploying AMM Contracts to Lux Local ==="
echo "RPC: $RPC_URL"
echo "Deployer: $DEPLOYER"

# Check balance
BALANCE=$(cast balance $DEPLOYER --rpc-url $RPC_URL)
echo "Deployer Balance: $BALANCE"

# Get current nonce
NONCE=$(cast nonce $DEPLOYER --rpc-url $RPC_URL)
echo "Current Nonce: $NONCE"

# Contract paths
V2_CORE="/Users/z/work/lux/standard/node_modules/.pnpm/@uniswap+v2-core@1.0.1/node_modules/@uniswap/v2-core/build"
V2_PERIPHERY="/Users/z/work/lux/standard/node_modules/.pnpm/@uniswap+v2-periphery@1.1.0-beta.0/node_modules/@uniswap/v2-periphery/build"

# Deploy WETH9 (WLUX)
echo ""
echo "=== Deploying WLUX (WETH9) ==="
WETH_BYTECODE=$(cat "$V2_PERIPHERY/WETH9.json" | jq -r '.bytecode')
WLUX_TX=$(cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY --create "$WETH_BYTECODE" --json 2>&1)
WLUX_ADDRESS=$(echo "$WLUX_TX" | jq -r '.contractAddress')
echo "WLUX deployed at: $WLUX_ADDRESS"

# Deploy UniswapV2Factory
echo ""
echo "=== Deploying UniswapV2Factory ==="
V2FACTORY_BYTECODE=$(cat "$V2_CORE/UniswapV2Factory.json" | jq -r '.bytecode')
# Constructor arg: feeToSetter (use deployer)
V2FACTORY_TX=$(cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY --create "${V2FACTORY_BYTECODE}$(cast abi-encode "constructor(address)" $DEPLOYER | cut -c3-)" --json 2>&1)
V2FACTORY_ADDRESS=$(echo "$V2FACTORY_TX" | jq -r '.contractAddress')
echo "V2Factory deployed at: $V2FACTORY_ADDRESS"

# Deploy UniswapV2Router02
echo ""
echo "=== Deploying UniswapV2Router02 ==="
V2ROUTER_BYTECODE=$(cat "$V2_PERIPHERY/UniswapV2Router02.json" | jq -r '.bytecode')
# Constructor args: factory, WETH
V2ROUTER_TX=$(cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY --create "${V2ROUTER_BYTECODE}$(cast abi-encode "constructor(address,address)" $V2FACTORY_ADDRESS $WLUX_ADDRESS | cut -c3-)" --json 2>&1)
V2ROUTER_ADDRESS=$(echo "$V2ROUTER_TX" | jq -r '.contractAddress')
echo "V2Router deployed at: $V2ROUTER_ADDRESS"

# Deploy Multicall3 (standard bytecode)
echo ""
echo "=== Deploying Multicall3 ==="
# Multicall3 standard bytecode (from https://github.com/mds1/multicall)
MULTICALL_BYTECODE="0x608060405234801561001057600080fd5b50610ee0806100206000396000f3fe6080604052600436106100f35760003560e01c80634d2301cc1161008a578063a8b0574e11610059578063a8b0574e1461025a578063bce38bd714610275578063c3077fa914610288578063ee82ac5e1461029b57600080fd5b80634d2301cc146101ec57806372425d9d1461022157806382ad56cb1461023457806386d516e81461024757600080fd5b80633408e470116100c65780633408e47014610191578063399542e9146101a45780633e64a696146101c657806342cbb15c146101d957600080fd5b80630f28c97d146100f8578063174dea711461011a578063252dba421461013a57806327e86d6e1461015b575b600080fd5b34801561010457600080fd5b50425b6040519081526020015b60405180910390f35b61012d610128366004610a85565b6102ba565b6040516101119190610bbe565b61014d610148366004610a85565b6104ef565b604051610111929190610bd8565b34801561016757600080fd5b50437fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0telecut0140610107565b34801561019d57600080fd5b5046610107565b6101b76101b2366004610c60565b610690565b60405161011193929190610cba565b3480156101d257600080fd5b5048610107565b3480156101e557600080fd5b5043610107565b3480156101f857600080fd5b50610107610207366004610ce2565b73ffffffffffffffffffffffffffffffffffffffff163190565b34801561022d57600080fd5b5044610107565b61012d610242366004610a85565b6106ab565b34801561025357600080fd5b5045610107565b34801561026657600080fd5b50604051418152602001610111565b61012d610283366004610c60565b61085a565b6101b7610296366004610a85565b610a1a565b3480156102a757600080fd5b506101076102b6366004610d18565b4090565b60606000828067ffffffffffffffff8111156102d8576102d8610d31565b60405190808252806020026020018201604052801561031e57816020015b6040805180820190915260008152606060208201528152602001906001900390816102f65790505b5092503660005b8281101561047757600085828151811061034157610341610d60565b6020026020010151905087878381811061035d5761035d610d60565b905060200281019061036f9190610d8f565b6040810135958601959093506103886020850185610ce2565b73ffffffffffffffffffffffffffffffffffffffff16816103ac6060870187610dcd565b6040516103ba929190610e32565b60006040518083038185875af1925050503d80600081146103f7576040519150601f19603f3d011682016040523d82523d6000602084013e6103fc565b606091505b50602080850191909152901telecut5161042157815160208301fd5b8461042f6020840183610ce2565b73ffffffffffffffffffffffffffffffffffffffff167f5765676fa35997a8d13cb5d0d4c839f1be3f59e8f0593c92cd40dc3f61a4a8c18460200151604051610478919061"
MULTICALL_TX=$(cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY --create "$MULTICALL_BYTECODE" --json 2>&1 || echo '{"contractAddress": "failed"}')
MULTICALL_ADDRESS=$(echo "$MULTICALL_TX" | jq -r '.contractAddress')
echo "Multicall3 deployed at: $MULTICALL_ADDRESS"

echo ""
echo "=== Deployment Summary ==="
echo "WLUX:       $WLUX_ADDRESS"
echo "V2Factory:  $V2FACTORY_ADDRESS"
echo "V2Router:   $V2ROUTER_ADDRESS"
echo "Multicall:  $MULTICALL_ADDRESS"
echo ""
echo "Update CLI config at: /Users/z/work/lux/cli/cmd/ammcmd/config.go"
